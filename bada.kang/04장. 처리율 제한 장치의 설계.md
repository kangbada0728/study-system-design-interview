---
tags:
  - 학습정리
  - SLiPP_25차_스터디
  - 시스템_설계
  - 책_가상_면접_사례로_배우는_대규모_시스템_설계_기초
  - 책_System_Design_Interview
---
# Intro

> [!note] 처리율 제한 장치란
> 클라이언트 또는 서비스가 보내는 트래픽의 처리율(rate)을 제어하기 위한 장치

## 처리율 제한 장치를 두면 좋은점

- Dos(Denial of Service) 공격에 의한 자원 고갈을 방지할 수 있다.
- 추가 요청에 대한 처리를 제한하여 비용을 절감한다.
- 서버 과부하를 막는다.

# 1단계. 문제 이해 및 설계 범위 확정

- 어떤 종류의 처리율 제한 장치?
	- 서버측 API 를 위한 장치
- API 호출 제한 기준은?
	- 다양한 형태의 제어규칙 제어 필요
- 시스템 규모는?
	- 대규모 요청 처리 필요
- 분산환경?
	- 맞음
- 이 장치는 독립된 서비스? 아니면 애플리케이션 코드?
	- 그건 알아서
- 이 장치로 요청이 걸러지면 사용자에게 알림?
	- 해야함

이런식으로 핑퐁을 하면서 요구사항을 하나씩 맞춰가야 한다.


- 트위터가 API 제한을 하는 방식
	- 허용되는 최대 요청 수는 시간 간격, 지정된 기간 또는 기간을 기준
		-  가장 일반적인 요청 제한 간격은 15분
	- 사용 중인 인증 방법에 따라 속도 제한이 걸림
		- OAuth 1.0a 사용자 컨텍스트를 사용하는 경우, 각 사용자의 액세스 토큰 세트에 대해 기간당 하나의 제한
		- OAuth 2.0 베어러 토큰을 사용하는 경우, 앱의 요청에 대해 기간당 별도의 제한
		- ==왜 인증 방법에 따라 속도 제한이 걸릴까?==

# 2단계. 개략적 설계안 제시 및 동의 구하기

- 처리율 제한 장치는 어디에 둬야 할까?
	- 클라이언트에는 안두는 것이 위변조 방지에 좋음
	- 서버나 해당 장치를 놓을 미들웨어를 두는것이 좋음
	- ==미들웨어를 놓으면 애플리케이션에 직접 놓는것 보다 속도가 느리지 않을까? 속도 문제도 걱정==
	- 클라우드 마이크로서비스에서는 처리율 제한 장치는 API 게이트웨이 컴포넌트에 구현됨
		- 클라우드 업체가 유지 보수를 담당
		- ==이게 가장 좋아보이긴 한데 현재 회사에서는 비용문제 때문에 이런걸 안쓸것 같음 다른 회사에서는 어떨까?==
		- 

- 요청이 가로막히면 HTTP 상태 코드 429 를 반환
	- 구글에서도 그렇게 씀 [구글링크](https://developers.google.com/docs/api/limits?hl=ko)
	- 아마존도 마찬가지 [아마존링크](https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-request-throttling.html)

>[!note] 처리율 제한 장치 기능 만들때 참고할 수 있는 지침 2
>필요에 맞는 처리율 제한 알고리즘을 찾아라.

>[!note] 처리율 제한 장치 기능 만들때 참고할 수 있는 지침 1
>프로그래밍 언어, 캐시 서비스 등 현재 사용하고 있는 기술 스택을 점검하라. 현재 프로그래밍 언어가 서버 측 구현을 지원하기 충분할  정도로 효율이 높은지 확인하자.
>- ==다른 회사들은 이런 요청을 처리할 때 어떤 프로그래밍 언어를 쓸까? 자바는 불충분할까?==

## 처리율 제한 알고리즘

### 토큰 버킷 알고리즘

>[!note]
>토큰이 고정된 양까지 버킷에 사전 설정된 양으로 주기적으로 채워지고, API 요청 시마다 토큰이 하나씩 사라진다. 버킷에 토큰이 없으면 요청이 버려짐.

- 공급제한 규칙들
	- 일반적으로 API 엔드포인트마다 별도의 버킷을 둠.
		- 사용자 포스팅 개수 제어, 좋아요 버튼 제어 를 제어해야한다면 사용자마다 버킷을 3개 두는것임
	- IP 주소별로 처리율 제한을 할수도 있음
		- 그럼 IP 주소마다 버킷을 하나씩 둠
	- 시스템 처리율 자체를 통제하려면?
		- 모든 요청이 하나의 버킷을 공유하게 만듬

- 장점
	- 구현 쉬움
	- 메모리 사용이 효율적
	- 짧은 시간에 집중되는 트래픽도 처리 가능
- 단점
	- 버킷크기와 토큰 공급률이라는 두개의 인자를 튜닝하기 까다로움










1. Rate-limiting strategies and technizues : https://cloud.google.com/architecture/infra-reliability-guide/traffic-load?hl=ko
2. Twitter rate limits : https://developer.twitter.com/en/docs/twitter-api/v1/rate-limits
3. Google docs usage limits : https://developers.google.com/docs/api/limits?hl=ko
4. IBM microservices : https://www.ibm.com/topics/microservices
5. Throttle API requests for better throughput : https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-request-throttling.html
6. Stripe rate limiters : https://stripe.com/blog/rate-limiters
7. Shopify REST Admin API rate limits : https://shopify.dev/docs/api/usage/rate-limits
8. Better Rate Limiting With Redis Sorted Sets : https://engineering.classdojo.com/blog/2015/02/06/rolling-rate-limiter/
9. System Design - Rate limiter and Data modelling : https://medium.com/@saisandeepmopuri/system-design-rate-limiter-and-data-modelling-9304b0d18250
10. How we built rate limiting capable of scaling to millions of domains : https://blog.cloudflare.com/counting-things-a-lot-of-different-things/
11. Redis website : https://redis.io
12. Lyft rate limiting : https://github.com/envoyproxy/ratelimit
13. Scaling your API with rate limiters : https://stripe.com/blog/rate-limiters
14. Wat is edge computing : https://www.cloudflare.com/ko-kr/learning/serverless/glossary/what-is-edge-computing/
15. Rate Limit Reqeusts with Iptables : https://blog.programster.org/rate-limit-requests-with-iptables
16. OSI model : https://en.wikipedia.org/wiki/OSI_model#Layer_architecture
